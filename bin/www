#!/usr/bin/env node

(function () {
    var debug = require('debug')('cloud-drive');
    var env = require('../modules/config/configUtils').getConfigs().node_env;
    var sticky = require('sticky-session');

    process.env.NODE_ENV = env;
    var app = require('../app');
    app.set('port', process.env.PORT || 3000);

    // sticky-session built-in cluster worker
    return sticky(function () {
        var http = require('http'),
            upload = require('../modules/upload/upload');
        var server = http.createServer(app);
        upload.bind(server);
        console.log('worker pid: ' + process.pid);
        return server;
    }).listen(app.get('port'), function () {
        debug('Express server listening on port ' + app.get('port'));
    });
})();
